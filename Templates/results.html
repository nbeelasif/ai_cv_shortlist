<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Shortlisted Candidates</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .candidate-card {
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      padding: 1.5rem;
      background-color: #fff;
      transition: transform 0.2s;
      position: relative;
    }
    .candidate-card:hover {
      transform: translateY(-3px);
    }
    .candidate-photo {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 50%;
      border: 2px solid #dee2e6;
    }
    .summary-list {
      font-size: 0.95rem;
      margin-top: 0.5rem;
      padding-left: 1rem;
    }
    .toggle-btn {
      cursor: pointer;
      font-size: 0.85rem;
      color: #0d6efd;
    }
    .text-label {
      font-weight: 600;
      color: #6c757d;
    }
    .rank-badge {
      position: absolute;
      top: -10px;
      right: -10px;
      background-color: #ffc107;
      color: #000;
      font-size: 0.9rem;
      font-weight: bold;
      padding: 4px 10px;
      border-radius: 1rem;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container mt-4">
    <div class="text-center mb-4">
      <img src="{{ url_for('static', filename='images/Jusour logo-04.png') }}" alt="Logo" height="90">
    </div>

    <h3 class="mb-4 text-center">AI-Shortlisted Candidates</h3>

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
      {% for candidate in candidates %}
      <div class="col">
        <div class="candidate-card h-100 d-flex flex-column justify-content-between position-relative">
          <div class="rank-badge">Ranked #{{ loop.index }}</div>

          <div class="d-flex align-items-center mb-3">
            {% set photo_file = candidate.photo_path.replace('\\', '/') if candidate.photo_path else 'images/default-user.png' %}
            <img src="{{ url_for('static', filename=photo_file) }}" class="candidate-photo me-3" alt="Photo">
            <div>
              <h5 class="mb-0">{{ candidate.name }}</h5>
              <small class="text-muted">Applied: {{ candidate.applied_date }}</small><br>
              {% if candidate.relevance == 'Not Relevant' %}
                <span class="badge bg-danger mt-1">Not Relevant</span>
              {% elif candidate.relevance == 'Partially Relevant' %}
                <span class="badge bg-warning text-dark mt-1">Partially Relevant</span>
              {% else %}
                <span class="badge bg-success mt-1">Relevant</span>
              {% endif %}
            </div>
          </div>

          <div>
            <p class="mb-1"><span class="text-label">University:</span> {{ candidate.university }}</p>
            <p class="mb-1"><span class="text-label">University Rank:</span> {{ candidate.uni_rank }}</p>
            <p class="mb-1"><span class="text-label">Similarity Score:</span> {{ candidate.similarity_score }}</p>
            <p class="mb-2"><span class="text-label">Final Score:</span> 
              <span class="badge bg-success text-white">{{ candidate.final_score }}</span>
            </p>
            <p class="mb-1"><span class="text-label">Contact:</span> {{ candidate.contact }}</p>
            <p class="mb-1"><span class="text-label">Status:</span> {{ candidate.status }}</p>
            <p class="mb-2"><span class="text-label">Top Skills:</span> 
              {% for skill in candidate.skills %}
                <span class="badge bg-light text-dark me-1">{{ skill }}</span>
              {% endfor %}
            </p>

            <div class="mb-2">
              <span class="text-label">LLM Summary:</span>
              {% if candidate.summary and candidate.summary|length > 0 %}
              <ul class="summary-list" id="summary_{{ loop.index }}" style="display:none;">
                {% for point in candidate.summary %}
                  {% set clean_point = point.strip() %}
                  {% if clean_point.startswith("[âœ” Aligned]") %}
                    <li>
                      <span class="badge bg-success me-2">âœ” Aligned</span>
                      {{ clean_point.replace("[âœ” Aligned]", "").replace("<resume info>", "").strip() }}
                    </li>
                  {% elif clean_point.startswith("[âœ˜ Not Aligned]") %}
                    <li>
                      <span class="badge bg-danger me-2">âœ˜ Not Aligned</span>
                      {{ clean_point.replace("[âœ˜ Not Aligned]", "").replace("<resume info>", "").strip() }}
                    </li>
                  {% else %}
                    <li>{{ clean_point.replace("<resume info>", "").strip() }}</li>
                  {% endif %}
                {% endfor %}
              </ul>
              {% else %}
              <div class="text-muted small">No summary available.</div>
              {% endif %}
              <div class="toggle-btn mt-1" onclick="toggleSummary({{ loop.index }})">Show Summary</div>
            </div>

            <div class="d-flex gap-2 mt-3">
              <a href="{{ url_for('view_resume', filename=candidate.filename) }}" class="btn btn-outline-primary btn-sm" target="_blank">View Resume</a>
              <button class="btn btn-outline-success btn-sm">Interview</button>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Explanation Section -->
    <div class="row mt-5 g-4">
      <div class="col-md-6">
        <div class="card h-100 border-start border-success border-4 shadow-sm">
          <div class="card-body">
            <h5 class="text-success">ðŸ“Š Candidate Scoring Breakdown</h5>
            <ul class="small ps-3 mb-2">
              <li><strong>60â€“70%</strong> Resume Similarity (via BERT embeddings)</li>
              <li><strong>20â€“30%</strong> University Ranking (based on global databases)</li>
              <li><strong>Adaptive Weights:</strong> Adjusted by Relevance classification</li>
              <li><code>Final Score = (Similarity Ã— Weight) + (Rank Ã— Weight)</code></li>
            </ul>
            <div class="alert alert-info small mb-0">
              Only candidates marked <strong>Relevant</strong> or <strong>Partially Relevant</strong> are scored.
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card h-100 border-start border-primary border-4 shadow-sm">
          <div class="card-body">
            <h5 class="text-primary">ðŸ§  What the AI (LLM) Does</h5>
            <ul class="small ps-3 mb-2">
              <li><strong>Job Understanding:</strong> Extracts role, required experience, and key skills from JD</li>
              <li><strong>Candidate Relevance:</strong> Classifies each CV as <span class="text-success fw-bold">Relevant</span>, <span class="text-warning fw-bold">Partially Relevant</span>, or <span class="text-danger fw-bold">Not Relevant</span></li>
              <li><strong>Summary Generation:</strong> Highlights aligned vs non-aligned qualifications in clear bullets</li>
              <li><strong>Domain Filtering:</strong> Rejects unrelated fields like marketing/accounting for technical roles</li>
            </ul>
            <div class="alert alert-secondary small mb-0">
              The LLM simulates a recruiterâ€™s judgment by analyzing CVs with real-world context and accuracy.
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="text-center mt-5">
      <a href="{{ url_for('upload_jd') }}" class="btn btn-secondary me-2">Back to Upload JD</a>
      <a href="{{ url_for('upload_cvs') }}" class="btn btn-outline-dark">Upload More CVs</a>
    </div>
  </div>

  <script>
    function toggleSummary(index) {
      const el = document.getElementById(`summary_${index}`);
      const toggleBtn = el.nextElementSibling;
      if (el && toggleBtn) {
        if (el.style.display === "none") {
          el.style.display = "block";
          toggleBtn.innerText = "Hide Summary";
        } else {
          el.style.display = "none";
          toggleBtn.innerText = "Show Summary";
        }
      }
    }
  </script>
</body>
</html>
